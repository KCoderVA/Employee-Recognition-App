# Copyright 2025 Kyle J. Coder
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Mirror to Personal Repository
permissions:
  contents: read
  pull-requests: write

# This workflow automatically mirrors the enterprise repository to the personal
# public repository to maintain transparency and community access while keeping
# the enterprise repo as the canonical source.

on:
  push:
    branches:
      - main
      - 'release/**'
      - 'hotfix/**'
  workflow_dispatch:
    inputs:
      force_mirror:
        description: 'Force complete mirror (including all refs)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: read

jobs:
  mirror:
    name: Mirror to KCoderVA/Employee-Recognition-App
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout enterprise repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for complete mirror
          fetch-tags: true

      - name: Configure SSH for mirror push
        env:
          MIRROR_SSH_KEY: ${{ secrets.MIRROR_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$MIRROR_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Add personal repository remote
        run: |
          git remote add personal git@github.com:KCoderVA/Employee-Recognition-App.git
          git remote -v

      - name: Mirror push (full)
        if: github.event.inputs.force_mirror == 'true'
        run: |
          echo "ðŸ”„ Executing full mirror push (all refs)..."
          git push personal --mirror

      - name: Mirror push (standard)
        if: github.event.inputs.force_mirror != 'true'
        run: |
          echo "ðŸ”„ Executing standard mirror push..."
          # Push current branch
          git push personal "${GITHUB_REF#refs/heads/}:${GITHUB_REF#refs/heads/}" --force-with-lease

          # Push all tags
          git push personal --tags --force-with-lease

      - name: Verify mirror sync
        run: |
          echo "âœ… Mirror push completed successfully"
          echo "Source: department-of-veterans-affairs/578-EmployeeRecognitionApp"
          echo "Target: KCoderVA/Employee-Recognition-App"
          echo "Branch: ${GITHUB_REF#refs/heads/}"
          echo "Commit: ${GITHUB_SHA::8}"

      - name: Cleanup SSH keys
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519
          echo "ðŸ§¹ SSH keys cleaned up"

  notify-on-failure:
    name: Notify on Mirror Failure
    runs-on: ubuntu-latest
    needs: mirror
    if: failure()

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Mirror to Personal Repository Failed',
              body: `## Mirror Workflow Failure

              The automated mirror to \`KCoderVA/Employee-Recognition-App\` failed.

              **Details:**
              - Workflow Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              - Commit: ${context.sha}
              - Branch: ${context.ref}
              - Triggered by: ${context.eventName}

              **Action Required:**
              1. Review the workflow logs for errors
              2. Verify SSH key secret \`MIRROR_SSH_KEY\` is valid
              3. Check personal repository access permissions
              4. Manual resync may be required

              **Manual Resync Command:**
              \`\`\`bash
              git clone --mirror git@github.com:department-of-veterans-affairs/578-EmployeeRecognitionApp.git
              cd 578-EmployeeRecognitionApp.git
              git remote add personal git@github.com:KCoderVA/Employee-Recognition-App.git
              git push personal --mirror
              \`\`\`
              `,
              labels: ['bug', 'automation', 'mirror-sync']
            });
            console.log('Created issue:', issue.data.number);
