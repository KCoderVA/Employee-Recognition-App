# Copyright 2025 Kyle J. Coder
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Mirror to Enterprise Repository

# This workflow runs in the *personal* public repository (source of truth) and
# mirrors changes into the VA enterprise-controlled private repository.

on:
  push:
    branches:
      - main
      - 'release/**'
      - 'hotfix/**'
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository to mirror into (owner/repo)'
        required: false
        default: 'department-of-veterans-affairs/578-EmployeeRecognitionApp'
        type: string
      dry_run:
        description: 'Dry run (no writes): validate auth and refs only'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      force_mirror:
        description: 'Force complete mirror (including all refs)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: read
  issues: write  # needed for failure notification issue creation

jobs:
  mirror:
    name: Mirror to ${{ github.event.inputs.target_repo || 'department-of-veterans-affairs/578-EmployeeRecognitionApp' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      # Personal Access Token used to push to the target repository.
      # Configure as a repository secret: Settings â†’ Secrets and variables â†’ Actions â†’ MIRROR_PAT
      MIRROR_PAT: ${{ secrets.MIRROR_PAT }}
      TARGET_REPO: ${{ github.event.inputs.target_repo || 'department-of-veterans-affairs/578-EmployeeRecognitionApp' }}
      # `github.event.inputs` exists only for workflow_dispatch; default safely for push events.
      DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      FORCE_MIRROR: ${{ github.event.inputs.force_mirror || 'false' }}

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for complete mirror
          fetch-tags: true

      - name: Mirror PAT missing
        if: env.MIRROR_PAT == ''
        run: |
          echo "::warning title=Mirror PAT Missing::Secret MIRROR_PAT not configured; mirror steps will be skipped."
          echo "Add repo secret MIRROR_PAT (classic PAT with 'repo' scope, or fine-grained PAT with Contents: Read/Write for the target repo)."

      - name: Dry run enabled
        if: env.MIRROR_PAT != '' && env.DRY_RUN == 'true'
        run: |
          echo "::notice title=Dry Run Enabled::This run will validate authentication and ref updates, but will not write to the target repository."
          echo "Target: ${TARGET_REPO}"

      - name: Preflight target repository access
        if: env.MIRROR_PAT != ''
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${TARGET_REPO}"
          code="$(curl -sS -o /tmp/target-repo.json -w "%{http_code}" \
            -H "Authorization: Bearer ${MIRROR_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "${api}" || true)"

          if [ "${code}" = "200" ]; then
            # The REST payload usually includes a permissions object for authenticated callers.
            # We avoid jq (not guaranteed installed) and do a lightweight check.
            if grep -q '"push"[[:space:]]*:[[:space:]]*true' /tmp/target-repo.json; then
              echo "âœ… PAT can access and push to ${TARGET_REPO}"
              exit 0
            fi

            echo "::error title=Insufficient Token Permissions::PAT can see ${TARGET_REPO} but does not appear to have push permission. Ensure MIRROR_PAT includes Contents: Read/Write for that target repo (fine-grained) or 'repo' scope (classic)."
            echo "Response (first 80 lines):"
            sed -n '1,80p' /tmp/target-repo.json || true
            exit 1
          fi

          if [ "${code}" = "401" ]; then
            echo "::error title=Invalid MIRROR_PAT::GitHub API returned 401 for ${TARGET_REPO}. The token is invalid/expired."
            exit 1
          fi

          if [ "${code}" = "404" ]; then
            echo "::error title=Target Repo Not Found or Not Authorized::GitHub API returned 404 for ${TARGET_REPO}. This usually means the PAT does not have access to that private repo (or the repo name is wrong)."
            exit 1
          fi

          echo "::error title=Unexpected GitHub API Response::GitHub API returned HTTP ${code} for ${TARGET_REPO}."
          echo "Response (first 80 lines):"
          sed -n '1,80p' /tmp/target-repo.json || true
          exit 1

      - name: Configure enterprise repository remote
        if: env.MIRROR_PAT != ''
        run: |
          # Avoid echoing secrets. Configure an authenticated HTTPS remote using the PAT.
          git remote remove enterprise 2>/dev/null || true
          git remote add enterprise "https://github.com/${TARGET_REPO}.git"
          git remote set-url enterprise "https://x-access-token:${MIRROR_PAT}@github.com/${TARGET_REPO}.git"

      - name: Mirror push (full) - dry run
        if: env.MIRROR_PAT != '' && github.event_name == 'workflow_dispatch' && env.FORCE_MIRROR == 'true' && env.DRY_RUN == 'true'
        run: |
          echo "ðŸ”„ DRY RUN: Full mirror push (all refs)..."
          git push enterprise --mirror --dry-run

      - name: Mirror push (full)
        if: env.MIRROR_PAT != '' && github.event_name == 'workflow_dispatch' && env.FORCE_MIRROR == 'true' && env.DRY_RUN != 'true'
        run: |
          echo "ðŸ”„ Executing full mirror push (all refs)..."
          git push enterprise --mirror

      - name: Mirror push (standard) - dry run
        if: env.MIRROR_PAT != '' && !(github.event_name == 'workflow_dispatch' && env.FORCE_MIRROR == 'true') && env.DRY_RUN == 'true'
        run: |
          echo "ðŸ”„ DRY RUN: Standard mirror push..."
          branch="${GITHUB_REF#refs/heads/}"
          git push enterprise "${branch}:${branch}" --force --dry-run
          git push enterprise --tags --force --dry-run

      - name: Mirror push (standard)
        if: env.MIRROR_PAT != '' && !(github.event_name == 'workflow_dispatch' && env.FORCE_MIRROR == 'true') && env.DRY_RUN != 'true'
        run: |
          echo "ðŸ”„ Executing standard mirror push..."
          # Push current branch
          branch="${GITHUB_REF#refs/heads/}"
          git push enterprise "${branch}:${branch}" --force

          # Push all tags
          git push enterprise --tags --force

      - name: Verify mirror sync
        if: env.MIRROR_PAT != ''
        run: |
          echo "âœ… Mirror push step completed"
          echo "Source: ${GITHUB_REPOSITORY}"
          echo "Target: ${TARGET_REPO}"
          echo "Dry run: ${DRY_RUN}"
          echo "Branch: ${GITHUB_REF#refs/heads/}"
          echo "Commit: ${GITHUB_SHA::8}"

  notify-on-failure:
    name: Notify on Mirror Failure
    runs-on: ubuntu-latest
    needs: mirror
    if: failure()

    env:
      TARGET_REPO: ${{ github.event.inputs.target_repo || 'department-of-veterans-affairs/578-EmployeeRecognitionApp' }}

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Mirror to Enterprise Repository Failed',
              body: `## Mirror Workflow Failure

              The automated mirror to \`${process.env.TARGET_REPO}\` failed.

              **Details:**
              - Workflow Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              - Commit: ${context.sha}
              - Branch: ${context.ref}
              - Triggered by: ${context.eventName}

              **Action Required:**
              1. Review the workflow logs for errors
              2. Verify mirror secret \`MIRROR_PAT\` is valid and has access to the target repo
              3. Confirm the target repo name is correct
              4. Manual resync may be required

              **Manual Resync Command:**
              \`\`\`bash
              # Using a PAT (recommended):
              # export MIRROR_PAT=...  (classic PAT: repo scope; fine-grained PAT: contents read/write)
              git clone --mirror https://github.com/${context.repo.owner}/${context.repo.repo}.git
              cd ${context.repo.repo}.git
              git remote add enterprise https://github.com/${process.env.TARGET_REPO}.git
              git remote set-url enterprise "https://x-access-token:${MIRROR_PAT}@github.com/${process.env.TARGET_REPO}.git"
              git push enterprise --mirror
              \`\`\`
              `,
              labels: ['bug', 'automation', 'mirror-sync']
            });
            console.log('Created issue:', issue.data.number);
